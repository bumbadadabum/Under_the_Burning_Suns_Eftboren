#textdomain wesnoth-utbs
# Level 6.a: In the Tunnels of the Trolls

[scenario]
    id=06a_In_the_Tunnels_of_the_Trolls_new
    name= _ "In the Tunnels of the Trolls"
    next_scenario=07a_Dealing_with_Dwarves
    victory_when_enemies_defeated=no
    {UTBS_MAP 06a_In_the_Tunnels_of_the_Trolls_new.map}
    {TURNS 62 58 56}

    {UNDERGROUND}

    {SCENARIO_MUSIC "the_deep_path.ogg"}

    {STORY_IN_THE_TUNNELS_OF_THE_TROLLS}

#define LAVA_CAVERN
    x=6-11,10-16,17-21,17,12-16,22-28,29,27-28,30-38,29,39-40,24-26,19-20,21,20
    y=27-35,34-38,23-35,36-37,27-33,27-36,30-37,37,33-41,40,36-41,26,19-22,21,18
#enddef

    #Elf player
    [side]
        side=1
        id=Kaleh
        type=Quenoth Hunter
        canrecruit=yes
        gold=200
        {INCOME 5 3 1}
        controller=human
        shroud=yes
        fog=no
        team_name=dwarf_ally
        user_team_name= _ "team_name^Intruders"
        {FLAG_VARIANT long}
    [/side]

    #Side=2 dwarf 1 (dwarf allies)
    [side]
        side=2
        color=orange
        no_leader=yes
        gold=0
        income=0
        controller=ai
        hidden=yes
        shroud=no
        fog=no
        team_name=dwarf_ally
        {FLAG_VARIANT knalgan}
    [/side]

    #Side=3 troll 1 (advance guard trolls at outpost)
    [side]
        side=3
        color=green
        no_leader=yes
        gold=0
        income=0
        controller=ai
        hidden=yes
        shroud=no
        fog=no
        team_name=monster

#ifdef EASY
        recruit=Troll Whelp, Troll
#endif

#ifdef NORMAL
        recruit=Troll Whelp, Troll, Troll Rocklobber
#endif

#ifdef HARD
        recruit=Troll Whelp, Troll, Troll Rocklobber, Troll Shaman
#endif

        [ai]
#ifdef EASY
            recruitment_pattern=fighter,fighter
#endif
#ifdef NORMAL
            recruitment_pattern=fighter,fighter,mixed fighter
#endif
#ifdef HARD
            recruitment_pattern=fighter,fighter,mixed fighter
#endif

            # AI will attack a weak unit with a max of 3,4,5 units
            # depending on the difficulty (default=5)
            {ATTACK_DEPTH 3 4 5}

            aggression=0.6
        [/ai]
    [/side]

    #Side=4 troll 2 (elite trolls in main lair)
    [side]
        side=4
        color=brown
        no_leader=yes
        gold=0
        income=-50
        controller=ai
        hidden=yes
        shroud=no
        fog=no
        team_name=monster

#ifdef EASY
        recruit=Troll Whelp, Troll, Troll Rocklobber
#endif

#ifdef NORMAL
        recruit=Troll Whelp, Troll, Troll Rocklobber, Troll Shaman
#endif

#ifdef HARD
        recruit=Troll Whelp, Troll, Troll Rocklobber, Troll Shaman
#endif

        [ai]
            recruitment_pattern=fighter,fighter,mixed fighter

            # AI will attack a weak unit with a max of 3,4,5 units
            # depending on the difficulty (default=5)
            {ATTACK_DEPTH 3 4 5}

            aggression=0.6
        [/ai]
    [/side]

    #Side=5 fire guardians
    [side]
        side=5
        color=white
        no_leader=yes
        gold=0
        income=0
        controller=ai
        hidden=yes
        shroud=no
        fog=no
        team_name=monster
        [ai]
            aggression=0.9
            caution=0.1

            village_value=0

            # AI will attack a weak unit with a max of 3,4,5 units
            # depending on the difficulty (default=5)
            {ATTACK_DEPTH 3 4 5}

            #fire guardians can't leave the lava cavern
            [avoid]
                [not]
                    {LAVA_CAVERN}
                [/not]
            [/avoid]
        [/ai]
    [/side]

    #Side=6 ghost
    [side]
        side=6
        color=black
        no_leader=yes
        gold=0
        income=0
        controller=ai
        hidden=yes
        shroud=no
        fog=no
        team_name=monster,dwarf_ally
    [/side]

    {UTBS_INCLUDE utils/dialog-macros.cfg}

    # Prestart functions:
    # set starting scenario objectives
    # increase cost of recruiting units
    # place item images on map
    # recall main heroes
    # recall dwarf allies
    # initialize starting variables
    # remove keep
    # create elf units
    # create AI=guardian starting units

    [event]
        name=prestart

        # test units

        #{NAMED_NOTRAIT_UNIT 1 (Dwarvish Fighter) 23 7 (Test) ( _ "Test")}

        #set starting scenario objectives

        [objectives]
            summary= _ "Starting Objectives:"
            [objective]
                description= _ "Kill the trollsâ€™ leader"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Kaleh"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Nym"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Zhul"
                condition=lose
            [/objective]

            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]

        #increase the cost of all units by 1
        {INCREASE_RECRUIT_COSTS_BY_ONE}

        #secret troll tomb furnishings
        {PLACE_IMAGE items/coffin-closed.png 9 18}
        {PLACE_IMAGE items/bones.png 13 22}

        #troll burial grounds furnishings

        {PLACE_IMAGE items/burial.png 46 33}
        {PLACE_IMAGE items/burial.png 44 33}
        {PLACE_IMAGE items/burial.png 44 37}
        {PLACE_IMAGE items/burial.png 50 32}

        {PLACE_IMAGE scenery/monolith1.png 41 37}
        {PLACE_IMAGE scenery/monolith4.png 43 38}

        #other furnishings

        {PLACE_IMAGE items/bones.png 23 24}

        #recall heroes
        [unit]
            {NYM}
            placement=leader
        [/unit]

        [unit]
            {ZHUL}
            placement=leader
        [/unit]

        [recall]
            id=Elyssa
        [/recall]

        [store_unit]
            [filter]
                side=1
                x,y=recall,recall
                race=dwarf
            [/filter]

            variable=dwarf_allies_store
        [/store_unit]

        {FOREACH dwarf_allies_store i}
            [recall]
                id=$dwarf_allies_store[$i].id
            [/recall]
        {NEXT i}

        {CLEAR_VARIABLE dwarf_allies_store}
        {CLEAR_VARIABLE i}

        {VARIABLE troll_undead_arose 0}

        # create AI=guardian units. They can't move unless an enemy
        # moves nearby. I create them at the beginning because when the
        # player sees them, events will fire.

        [unit]
            type=Dwarvish Pathfinder
            id=Grimnir
            name= _ "Grimnir"
            x,y=7,6
            side=2
            ai_special=guardian
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        # Event 2.1
        #Troll interrogators guardian

        [unit]
            type=Troll
            id=Troll Interrogator
            name= _ "Troll Interrogator"
            x=43
            y=7
            side=3
            ai_special=guardian
            facing=sw
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]

        [unit]
            type=Troll Whelp
            id=Troll Assistant
            name= _ "Troll Assistant"
            x=41
            y=7
            side=3
            ai_special=guardian
            facing=se
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
            {IS_LOYAL}
        [/unit]

        [unit]
            type=Troll Whelp
            id=Ulg
            name= _ "Ulg"
            x=42
            y=8
            side=3
            ai_special=guardian
            facing=ne
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
            {IS_LOYAL}
        [/unit]

#ifdef HARD
        [unit]
            type=Troll Whelp
            name= _ "Troll Assistant"
            x=40
            y=8
            side=3
            ai_special=guardian
            facing=ne
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
#endif

        # Event 3: Troll High Shamans guarding lava maze

        [unit]
            type=Troll Shaman
            id=Troll High Shaman 1
            role=Troll High Shaman
            name= _ "Troll High Shaman"
            x,y=23,31
            side=4
            ai_special=guardian
            facing=ne
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
                [object]
                    id=t3
                    silent=yes
                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        [movement_costs]
                            cave={UNREACHABLE}
                            flat={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
            {IS_LOYAL}
        [/unit]

        [unit]
            type=Troll Shaman
            id=Troll High Shaman 2
            role=Troll High Shaman
            name= _ "Troll High Shaman"
            x,y=25,32
            side=4
            ai_special=guardian
            facing=ne
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
                [object]
                    id=t4
                    silent=yes
                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        [movement_costs]
                            cave={UNREACHABLE}
                            flat={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
            {IS_LOYAL}
        [/unit]

        # reveal a bit of the escape passage to the player
        [remove_shroud]
            x,y=5-8,4-6
            side=1
        [/remove_shroud]
    [/event]

    # starting events

    [event]
        name=start

        # starting dialogue

        [message]
            speaker=Grimnir
            message= _ "This passage leads very close to the trollsâ€™ main lair; you can hear them tromping back and forth just past the eastern wall. All that separates us from the trolls is a thin wall of stone. Iâ€™ve had me boys mine the end of the tunnel with explosives; when you move a unit adjacent to the final wall, Iâ€™ll blow the charges and open the way. The troll leader should only be lightly defended; heâ€™s sent most of his best warriors to the front. Youâ€™ll know the head troll when you see him â€” heâ€™s big, gray, and extra ugly."
        [/message]

        [message]
            speaker=Nym
            message= _ "I thought thatâ€™s what all the trolls looked like. I suppose weâ€™ll just try to find the one that shouts the loudest."
        [/message]

        [message]
            speaker=Zhul
            message= _ "So you dug these tunnels all by yourselves?"
        [/message]

        [message]
            speaker=Grimnir
            message= _ "Long ago, before the damned trolls invaded, we spent our days digging tunnels all through these mountains. Oh the ore and precious stones we mined! The mines were filled with the joyful sound of dwarven hammer and dwarven song and our jeweled halls glowed as brightly as the sun. Human and elf princes would pay us royally for the craftsmanship of our forges. But now the tunnels are silent and we spend our days hunting those accursed trolls. But thereâ€™s no point dwelling on the past. Thereâ€™s more work to be done! Still, we have our honor and I promise you, do this for us and you will be rewarded handsomely."
        [/message]

        [message]
            speaker=Kaleh
            message= _ "It shall be done."
        [/message]
    [/event]

    # Event 1: Blow up wall, encounter advance troll guards

    # when player moves next wall trigger variable
    [event]
        name=moveto

        [filter]
            x,y=15,7
            side=1
        [/filter]

        [message]
            speaker=Grimnir
            message= _ "Once you are done moving your people into position, I will blow the charges."
        [/message]

        # at start of playerâ€™s next turn, blow charges and destroy wall
        [event]
            name=new turn

            # Modify troll's income

            [modify_side]
                side=3
                {INCOME 5 7 9}
                {GOLD 50 75 100}
            [/modify_side]

            # Place troll guards

            # EASY:  1 Troll Leader, 2 troll whelps, 1 rocklobber
            # NORMAL: 1 Troll Leader, 3 troll whelps, 1 rocklobber
            # HARD: 1 Troll Leader, 3 troll whelps, 1 rocklobber, 1 troll

            # 1 Troll Leader
            [unit]
                id=Troll Brute
                name= _ "Troll Brute"
                type=Troll
                x=30
                y=13
                side=3
                canrecruit=yes
                facing=nw
                [modifications]
                    {TRAIT_STRONG}
                    {TRAIT_RESILIENT}
                [/modifications]
            [/unit]

            # 2 Troll Whelps
            {NAMED_NOTRAIT_UNIT 3 (Troll Whelp) 24 7 () ( _ "Troll Guard")}
            {FACING nw}

            {NAMED_NOTRAIT_UNIT 3 (Troll Whelp) 24 9 (Troll Guard) ( _ "Troll Guard")}
            {FACING nw}

            # 2-3 troll whelps occupy base and villages
            # 2 troll whelps in villages
            {NAMED_NOTRAIT_UNIT 3 (Troll Whelp) 26 6 () ( _ "Troll Guard")}
            {FACING nw}
            {GUARDIAN}

            {NAMED_NOTRAIT_UNIT 3 (Troll Whelp) 29 10 () ( _ "Troll Guard")}
            {FACING nw}
            {GUARDIAN}

#ifndef EASY
            {NAMED_NOTRAIT_UNIT 3 (Troll Whelp) 27 9 () ( _ "Troll Guard")}
            {FACING nw}
            {GUARDIAN}
#endif
            # wmllint: recognize Troll Guard

            # Have Grimnir blow the explosives to destroy the wall

            [message]
                speaker=Grimnir
                message= _ "Fire in the hole!"
            [/message]

            [sound]
                name=fuse.ogg
            [/sound]

            # Have screen flash red

            [color_adjust]
                red,green,blue=255,0,0
            [/color_adjust]

            [redraw]
            [/redraw]

            [delay]
                time=1000
            [/delay]

            [color_adjust]
                red,green,blue=0,0,0
            [/color_adjust]

            [redraw]
            [/redraw]

            [sound]
                name=explosion.ogg
            [/sound]

            # Have wall shake, then be replaced by dirt, then add rubble

            [scroll]
                x=20
            [/scroll]
            [scroll]
                x=-20
            [/scroll]
            [scroll]
                x=20
            [/scroll]
            [scroll]
                x=-20
            [/scroll]

            [terrain]
                x,y=16,7
                terrain=Re
            [/terrain]

            [redraw]
            [/redraw]

            {PLACE_IMAGE scenery/rubble.png 16 7}

            # Reveal dwarven cavern
            [remove_shroud]
                x=16-25
                y=3-10
                side=1
            [/remove_shroud]

            # Have Grimnir say goodbye

            [message]
                speaker=Grimnir
                message= _ "My work here is done. I must report back to my King. I have many more things to do before the day is done, but I will once you finish your mission. Fight well!"
            [/message]

            # Have him leave
            [kill]
                id=Grimnir
                animate=no
                fire_event=no
            [/kill]

            [move_unit_fake]
                type=Dwarvish Pathfinder
                side=2
                x=7,6,5,4,3,2,1
                y=6,5,5,4,5,4,4
            [/move_unit_fake]

            [terrain]
                x,y=1,4
                terrain=Xu
            [/terrain]

            {PLACE_IMAGE scenery/rubble.png 2 4}

            [redraw][/redraw]

            # Have troll guards talk

            [message]
                speaker=Troll Guard
                message= _ "Intruders! Kill them!"
            [/message]

            # If player tries to go back up escape passage
            [event]
                name=moveto

                [filter]
                    x=2-5,4-5
                    side=1
                [/filter]

                [message]
                    speaker=unit
                    message= _ "Grimnir must have collapsed the tunnel. Perhaps he didnâ€™t want to give the trolls an easy access route if they defeated us. So much for an escape route, I guess weâ€™ll just have to be sure not to fail."
                [/message]
            [/event]
        [/event]
    [/event]

    # Event 2: Troll Interrogators

    # When player appears 3 trolls are interrogating a wounded dwarf
    # When they see the player they kill the dwarf. The other says
    # "The prisoners must not be allowed to escape. Kill the other prisoner
    # while we hold them off!"

    # Troll and Troll whelp try to hold off player

    # I create trolls well in advance of player entering cave
    # this makes sure that player can't move into trolls hexes
    # I am forced to make trolls into guardians to keep them
    # from moving prematurely

    # Moveto version (sighted version is disabled)

    [event]
        name=interrogation

        [remove_shroud]
            x=28-35
            y=3-9
            side=1
        [/remove_shroud]

        [unit]
            type=Dwarvish Fighter
            id=Wounded Dwarf
            name= _ "Wounded Dwarf"
            x=42
            y=7
            side=2
            hitpoints=5
        [/unit]

        [message]
            speaker=Troll Interrogator
            message= _ "Tell us where your leader is hiding!"
        [/message]

        [message]
            speaker=Wounded Dwarf
            message= _ "Never!"
        [/message]

        [message]
            speaker=Troll Assistant
            message= _ "Master, look!"
        [/message]

        [message]
            speaker=Troll Interrogator
            message= _ "Hah! You think you can save your friends. You are wrong. Ulg, go kill the other prisoner. We will deal with these fools."
        [/message]

        [message]
            speaker=Ulg
            message= _ "Yes master, Iâ€™ll make him suffer."
        [/message]

        {MOVE_UNIT id=Ulg 50 5}

        [animate_unit]
            [filter]
                id=Troll Interrogator
            [/filter]
            flag=attack
            hits=yes
            [primary_attack]
                name=club
            [/primary_attack]
            [facing]
                [filter]
                    id=Wounded Dwarf
                [/filter]
            [/facing]

            [animate]
                [filter]
                    id=Wounded Dwarf
                [/filter]
                flag=defend
                hits=yes
                [secondary_attack]
                    name=axe
                [/secondary_attack]
                [facing]
                    [filter]
                        id=Troll Interrogator
                    [/filter]
                [/facing]
            [/animate]
        [/animate_unit]

        [message]
            speaker=Wounded Dwarf
            message= _ "Aaahh!" # wmllint: no spellcheck
        [/message]

        [kill]
            id=Wounded Dwarf
            animate=yes
        [/kill]

        [message]
            speaker=$explorer.id
            message= _ "If we move fast we might be able to save the other prisoner before he gets killed too."
        [/message]

        {CLEAR_VARIABLE explorer}
    [/event]

    [event]
        name=rogrimir

        [unit]
            type=Dwarvish Stalwart
            id=Rogrimir
            name= _ "Rogrimir"
            profile=portraits/rogrimir.png
            x=51
            y=5
            side=2
            hitpoints=20
            unrenamable=yes
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_QUICK}
            [/modifications]
            {IS_LOYAL}
        [/unit]

        [remove_shroud]
            x=34-42
            y=4-8
            side=1
        [/remove_shroud]

        [message]
            speaker=Ulg
            message= _ "Iâ€™m gonna make you squeal, dwarf!"
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [if]
            [have_unit]
                [and]
                    id=Troll Interrogator

                    [or]
                        id=Ulg
                    [/or]
                [/and]
                [filter_vision]
                    visible=yes
                    viewing_side=1
                [/filter_vision]
            [/have_unit]

            [variable]
                name=interrogation_seen
                boolean_equals=no
            [/variable]

            [then]
                {CHECK_EXPLORER}
                [fire_event]
                    name=interrogation
                [/fire_event]

                {VARIABLE interrogation_seen yes}

                # Event 2.2: Wounded Dwarf

                # Troll whelp tries to kill wounded Dwarvish Stalwart

                [event]
                    name=moveto
                    first_time_only=no

                    [if]
                        [have_unit]
                            id=Ulg
                            side=3
                            [filter_vision]
                                visible=yes
                                viewing_side=1
                            [/filter_vision]
                        [/have_unit]

                        [then]
                            [fire_event]
                                name=rogrimir
                            [/fire_event]
                        [/then]
                        [else]
                            [allow_undo]
                            [/allow_undo]
                        [/else]
                    [/if]
                [/event]
            [/then]
            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

    # when Ulg dies, Rogrimir thanks player

    [event]
        name=die

        [filter]
            id=Ulg
        [/filter]

        {VARIABLE saved_rogrimir yes}

        [message]
            speaker=Rogrimir
            message= _ "I owe you my life. I canâ€™t believe I was captured when those all around me died fighting gloriously. Iâ€™m so ashamed. I could not protect them... but I will guard you with my life, even if I have to follow you to the ends of the earth. Now lead me to the trolls and let me avenge my friendsâ€™ deaths!"
        [/message]

        [modify_unit]
            [filter]
                id=Rogrimir
            [/filter]
            side=1
            moves=5
        [/modify_unit]
    [/event]

    # Event 3: Troll Lava Room

    # This macro is used to create the fire guardian
#define SUMMON_FIRE_GUARDIAN
    [color_adjust]
        red,green,blue=255,0,0
    [/color_adjust]

    [redraw]
    [/redraw]

    [delay]
        time=100
    [/delay]

    [color_adjust]
        red,green,blue=0,0,0
    [/color_adjust]

    [redraw]
    [/redraw]

    {NAMED_NOTRAIT_UNIT 5 ({ON_DIFFICULTY (Fire Guardian) (Fire Guardian2) (Fire Guardian3)}) 17 31 (Guardian Phoenix) ( _ "Guardian Phoenix")}

    [scroll_to_unit]
        x,y=17,31
    [/scroll_to_unit]

    [delay]
        time=250
    [/delay]

    [set_variable]
        name=summon_flame
        value=0
    [/set_variable]
#enddef

    # At the start of each turn, all units in main cavern standing on a cave
    # floor hex, or lava hex, or a dirt hex or a road hex take 2,3,4 damage
    # from the heat. This damage is non-lethal.

    [event]
        name=new turn
        first_time_only=no

        [harm_unit]
            [filter]
                {LAVA_CAVERN}
                [not]
                    type=Fire Guardian,Fire Guardian2,Fire Guardian3,Dust Devil
                [/not]
            [/filter]

            amount={ON_DIFFICULTY 2 3 4}
            damage_type=fire
        [/harm_unit]
    [/event]

    #Initial moveto event to enter lava cavern

    [event]
        name=moveto

        [filter]
            x,y=25-30,27-30
            side=1
        [/filter]

        [remove_shroud]
            x,y=25,31
            radius=7
            side=1
        [/remove_shroud]

        [redraw]
        [/redraw]

        {CHECK_EXPLORER}
        [message]
            speaker=$explorer.id
            message= _ "Whoa. This place is hot."
        [/message]

        [message]
            speaker=$explorer.id
            message= _ "This cavern is so hot itâ€™s stifling; I can already feel my armor heating up. If we tarry here too long, weâ€™ll roast alive. I donâ€™t even want to think about what would happen if I fell into the lava. On the other hand, the lava does light up the cavern nicely. Iâ€™m just thankful that the lava hasnâ€™t swallowed everything in this room."
        [/message]

        [message]
            speaker=Troll High Shaman 1
            message= _ "Foul intruders, ye shall go no further! Turn back now or face the ruthlessness of the earthâ€™s belly!"
        [/message]

        [message]
            speaker=Troll High Shaman 2
            message= _ "I summon you, creatures of the earthâ€™s belly! Tear them asunder so that they can be fed to your mother! May she melt each and every one of those greedy wights!"
        [/message]

        {NAMED_NOTRAIT_UNIT 5 (Fire Guardian) 25 27 () ( _ "Guardian Phoenix")}
        {NAMED_NOTRAIT_UNIT 5 (Fire Guardian) 28 31 () ( _ "Guardian Phoenix")}
        {NAMED_NOTRAIT_UNIT 5 (Fire Guardian) 20 28 () ( _ "Guardian Phoenix")}

        [message]
            speaker=$explorer.id
            message= _ "What the hell are those things? This canâ€™t be good..."
        [/message]
        {CLEAR_VARIABLE explorer}

        # This is why we should have gettext plurals!
        [message]
            speaker=narrator

#ifdef EASY
            message= _ "Because of the heat in the cavern, all units in this room will take 2 hitpoints of fire damage at the start of each turn. This heat damage can reduce a unit to 1 hitpoint, but it canâ€™t kill it."
#endif

#ifdef NORMAL
            message= _ "Because of the heat in the cavern, all units in this room will take 3 hitpoints of fire damage at the start of each turn. This heat damage can reduce a unit to 1 hitpoint, but it canâ€™t kill it."
#endif

#ifdef HARD
            message= _ "Because of the heat in the cavern, all units in this room will take 4 hitpoints of fire damage at the start of each turn. This heat damage can reduce a unit to 1 hitpoint, but it canâ€™t kill it."
#endif

            image=wesnoth-icon.png
        [/message]

        # run trolls away so they can't be attacked
        [move_unit]
            id=Troll High Shaman 1
            to_x=23,30
            to_y=32,35
            check_passability=no
        [/move_unit]
        [move_unit]
            id=Troll High Shaman 2
            to_x=25,28,28
            to_y=33,34,36
            check_passability=no
        [/move_unit]

        # trigger fire guardian next turn
        [event]
            name=new turn

            [message]
                role=Troll High Shaman
                message= _ "Arise! Arise and engulf the intruders in your holy fire!"
            [/message]

            [remove_shroud]
                x,y=17,31
                radius=2
                side=1
            [/remove_shroud]

            {SUMMON_FIRE_GUARDIAN}

            [message]
                side=1
                x,y=16-29,11-23
                message= _ "Another fiery beast?"
            [/message]
        [/event]
    [/event]

    # pool of water lets player heal halfway

    [event]
        name=moveto

        [filter]
            x=34,20
            y=29,37
            side=1
        [/filter]

        {CHECK_EXPLORER}
        [message]
            speaker=$explorer.id
            message= _ "There is a small pool of water here. It must come from some spring deep underground. The water is cool and refreshing. Let me bathe in it a while and recover from the heat of that blasted cavern."
        [/message]
        {CLEAR_VARIABLE explorer}

        [message]
            speaker=narrator
            message= _ "At the start of each turn, any unit in either of the pools in this cavern will be healed by 10 hitpoints."
            image=wesnoth-icon.png
        [/message]
    [/event]

    # unit gets healed by 10 hp every turn

    [event]
        name=new turn
        first_time_only=no

        [heal_unit]
            [filter]
                x=34,20
                y=29,37
            [/filter]
            amount=10
            animate=yes
        [/heal_unit]
    [/event]

    # This function fires each turn and checks to see if it should summon
    # a "Guardian Phoenix" fire guardian, based on the value of the summon_flame
    # variable and on the value of the flame_counter

    # when the fire guardian unit dies, the flame_counter is reset to 0

    # each turn flame_counter is incremented until it reached 4 (on hard
    # difficulty) or 5, then a new fire guardian is summoned and
    # summon_flame is turned back to 0.

    # summon_flame=0: fire guardian has been created, is alive, don't create another
    # summon_flame=1: fire guardian has been killed, create another
    # summon_flame=3: player has reached troll shamans, stop summoning fire guardians

    [event]
        name=new turn
        first_time_only=no

        [set_variable]
            name=flame_counter
            add=1
        [/set_variable]

        [if]
            [variable]
                name=summon_flame
                numerical_equals=1
            [/variable]

            [variable]
                name=flame_counter
                greater_than={ON_DIFFICULTY 4 4 3}
            [/variable]

            [then]
                {SUMMON_FIRE_GUARDIAN}

                [message]
                    side=1
                    {LAVA_CAVERN}
                    message= _ "That thing just wonâ€™t stay dead!"
                [/message]
            [/then]
        [/if]
    [/event]

    # when fire guardian dies, switch summon_flame back to 1
    # and reset flame_counter back to 0

    [event]
        name=die
        first_time_only=no

        [filter]
            id=Guardian Phoenix
        [/filter]

        [if]
            [variable]
                name=summon_flame
                less_than=3
            [/variable]

            [then]
                [set_variable]
                    name=summon_flame
                    value=1
                [/set_variable]

                [set_variable]
                    name=flame_counter
                    value=0
                [/set_variable]
            [/then]
        [/if]
    [/event]

    # Troll shamans raise more Fire Guardians out of the lava

    [event]
        name=moveto

        [filter]
            x=15-26
            y=30-35
            side=1
        [/filter]

        [if]
            [variable]
                name=summon_flame
                numerical_not_equals=3
            [/variable]

            [then]
                [message]
                    role=Troll High Shaman
                    message= _ "Arise, hallowed guardians, and destroy them!"
                [/message]

                [scroll_to]
                    x,y=20,30
                [/scroll_to]

#ifdef EASY
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian) 25 31 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian) 19 28 () ( _ "Fire Guardian")}
#endif

#ifdef NORMAL
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian2) 25 31 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian2) 19 28 () ( _ "Fire Guardian")}
#endif

#ifdef HARD
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian3) 25 31 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian3) 17 31 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian3) 19 28 () ( _ "Fire Guardian")}
#endif

                {CHECK_EXPLORER}
                [message]
                    speaker=$explorer.id
                    message= _ "Look, more fire guardians!"
                [/message]
                {CLEAR_VARIABLE explorer}

                [remove_shroud]
                    x,y=33,38
                    radius=4
                    side=1
                [/remove_shroud]

                # run trolls away so they can't be attacked
                [move_unit]
                    id=Troll High Shaman 1
                    to_x=30,36,37,37
                    to_y=36,39,39,38
                    check_passability=no
                [/move_unit]
                [move_unit]
                    id=Troll High Shaman 2
                    to_x=29,35,35
                    to_y=36,39,41
                    check_passability=no
                [/move_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto

        [filter]
            x=26-33
            y=35-40
            side=1
        [/filter]

        [if]
            [variable]
                name=summon_flame
                numerical_not_equals=3
            [/variable]

            [then]
                [message]
                    role=Troll High Shaman
                    message= _ "Arise and attack them now, while they are vulnerable!"
                [/message]

                [scroll_to]
                    x,y=20,30
                [/scroll_to]

#ifdef EASY
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian) 26 36 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian) 32 34 () ( _ "Fire Guardian")}
#endif

#ifdef NORMAL
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian2) 26 36 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian2) 32 34 () ( _ "Fire Guardian")}
#endif

#ifdef HARD
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian3) 26 36 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian3) 32 34 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian3) 31 39 () ( _ "Fire Guardian")}
#endif

                {CHECK_EXPLORER}
                [message]
                    speaker=$explorer.id
                    message= _ "Oh great, even more fire guardians. When I get through this inferno Iâ€™m going to kill those trolls."
                [/message]
                {CLEAR_VARIABLE explorer}

                # run trolls away so they can't be attacked
                [move_unit]
                    id=Troll High Shaman 1
                    to_x=39,41,41
                    to_y=39,38,37
                    check_passability=no
                [/move_unit]
                [move_unit]
                    id=Troll High Shaman 2
                    to_x=40,42
                    to_y=38,39
                    check_passability=no
                [/move_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto

        [filter]
            x=34-41
            y=38=41
            side=1
        [/filter]

        [if]
            [variable]
                name=summon_flame
                numerical_not_equals=3
            [/variable]

            [then]
                [message]
                    role=Troll High Shaman
                    message= _ "They must not be allowed to cross to the other side! Kill them!"
                [/message]

                [scroll_to]
                    x,y=37,40
                [/scroll_to]

#ifdef EASY
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian) 39 38 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian) 40 40 () ( _ "Fire Guardian")}
#endif

#ifdef NORMAL
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian2) 39 38 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian2) 40 40 () ( _ "Fire Guardian")}
#endif

#ifdef HARD
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian3) 39 38 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian3) 40 40 () ( _ "Fire Guardian")}
                {NAMED_NOTRAIT_UNIT 5 (Fire Guardian3) 32 40 () ( _ "Fire Guardian")}
#endif
                {CHECK_EXPLORER}
                [message]
                    speaker=$explorer.id
                    message= _ "How surprising, more fire guardians. Iâ€™m going to be really glad to get out of this cavern."
                [/message]
                {CLEAR_VARIABLE explorer}
            [/then]
        [/if]
    [/event]

    #at end of lava cavern, trolls come alive
    [event]
        name=moveto

        [filter]
            x=39-42
            y=36-42
            side=1
        [/filter]

        [set_variable]
            name=summon_flame
            value=3
        [/set_variable]

        [message]
            id=Troll High Shaman 2
            message= _  "Despite the fire guardians, the elves have almost crossed the lava!"
        [/message]

        [message]
            id=Troll High Shaman 1
            message= _  "They obviously werenâ€™t enough. You go alert the others and summon reinforcements. I will hold them off for as long as I can."
        [/message]

        [message]
            id=Troll High Shaman 2
            message= _ "May Griknagh protect you. Iâ€™ll be back soon!"
        [/message]

        # let shaman that stays move
        [object]
            [filter]
                id=Troll High Shaman 2
            [/filter]
            silent=yes
            [effect]
                apply_to=movement_costs
                replace=yes
                [movement_costs]
                    cave=1
                    flat=1
                [/movement_costs]
            [/effect]
        [/object]

        [kill]
            id=Troll High Shaman 1
            animate=no
        [/kill]

        [move_unit_fake]
            type=Troll Shaman
            side=3
            x=41,43,43,49
            y=37,36,35,32
        [/move_unit_fake]

        # Create reinforcements for shaman to return with
        # Create 2 troll whelps and on Challening and Hard add a troll shaman

        {NAMED_GENERIC_UNIT 3 (Troll Whelp) 49 32 (reinforcement_1) ( _ "Troll Reinforcements")}
        [move_unit]
            id=reinforcement_1
            to_x,to_y=43,35
        [/move_unit]
        {NAMED_GENERIC_UNIT 3 (Troll Whelp) 49 32 (reinforcement_2) ( _ "Troll Reinforcements")}
        [move_unit]
            id=reinforcement_2
            to_x,to_y=46,36
        [/move_unit]

        #on challenging/hard add a troll shaman
#ifndef EASY

        [unit]
            type=Troll Shaman
            role=Troll High Shaman
            id=reinforce_shaman
            name= _ "Troll High Shaman"
            x,y=49,32
            side=4
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
            {IS_LOYAL}
        [/unit]
        [move_unit]
            id=reinforce_shaman
            to_x,to_y=46,34
        [/move_unit]
#endif
    [/event]

    # Event 23: Trigger Troll Lord's side

    [event]
        name=moveto

        [filter]
            x=41-50
            y=29-40
            side=1
        [/filter]

        #create troll leader
        [unit]
            type=Great Troll
            id=Troll Chieftain
            name= _ "Troll Chieftain"
            canrecruit=yes
            x=54
            y=24
            side=4
            facing=sw
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [modify_side]
            side=4
            {INCOME 2 4 6}
            {GOLD 120 140 160}
        [/modify_side]

        #capture troll chieftan's villages

        [capture_village]
            x,y=44-65,18-35
            side=4
        [/capture_village]
    [/event]

    #reveal cavern when player enters

    [event]
        name=moveto

        [filter]
            x=43-56,48-56
            y=26-33,34-36
            side=1
        [/filter]

        #create troll defenders

        {NAMED_GENERIC_UNIT 4 (Troll Whelp) 48 29 () ( _ "Troll Guard")}
        {NAMED_GENERIC_UNIT 4 (Troll Whelp) 51 32 () ( _ "Troll Guard")}
        {NAMED_GENERIC_UNIT 4 (Troll Rocklobber) 52 30 () ( _ "Troll Guard")}

#ifdef EASY
        {NAMED_GENERIC_UNIT 4 (Troll Whelp) 50 29 () ( _ "Troll Guard")}
#else
        {NAMED_GENERIC_UNIT 4 (Troll) 50 29 () ( _ "Troll Guard")}
        {NAMED_GENERIC_UNIT 4 (Troll Whelp) 45 30 () ( _ "Troll Guard")}
#endif

        [remove_shroud]
            x=43-56,48-56
            y=26-33,34-36
            side=1
        [/remove_shroud]

        [unit]
            type=Troll Shaman
            id=High Advisor
            name= _ "High Advisor"
            x=53
            y=29
            side=4
            ai_special=guardian
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
            {IS_LOYAL}
        [/unit]

        [message]
            speaker=High Advisor
            message= _ "Invade our most holy cavern at your peril. Long have we protected our sacred burial grounds from your foul kind, and we shall scatter your bones next to those of our ancestors."
        [/message]

        [message]
            speaker=Troll Chieftain
            message= _ "Destroy the invaders! Make them pay for the murders they have done!"
        [/message]
    [/event]

    # Event 24: Troll Undead Uprising

#define TROLL_UNDEAD_UPRISING

    [message]
        speaker=High Advisor
        message= _ "Arise, our brothers of ages past! Arise and destroy the intruders!"
    [/message]

    {NOTRAIT_UNIT 4 (Walking Corpse) 44 28}
    {INVOKE_TROLL_VARIATION}

    {NOTRAIT_UNIT 4 (Walking Corpse) 48 28}
    {INVOKE_TROLL_VARIATION}

    {NOTRAIT_UNIT 4 (Walking Corpse) 50 33}
    {INVOKE_TROLL_VARIATION}

    {NOTRAIT_UNIT 4 (Walking Corpse) 52 32}
    {INVOKE_TROLL_VARIATION}

#ifdef NORMAL

    {NOTRAIT_UNIT 4 (Walking Corpse) 51 27}
    {INVOKE_TROLL_VARIATION}

    {NOTRAIT_UNIT 4 (Walking Corpse) 55 33}
    {INVOKE_TROLL_VARIATION}

#endif

#ifdef HARD
    {NOTRAIT_UNIT 4 (Souless) 51 27}
    {INVOKE_TROLL_VARIATION}

    {NOTRAIT_UNIT 4 (Souless) 55 33}
    {INVOKE_TROLL_VARIATION}

#endif

#enddef

    # count number of elves that have entered the trolls cave. Once 3 elves
    # are in the cave, then active the troll undead uprising

    [event]
        name=new turn
        first_time_only=no

        [if]
            [have_location]
                x=43-56,48-56
                y=26-33,34-36
                [filter]
                    side=1
                [/filter]
                count=3-9001
            [/have_location]
            [variable]
                name=troll_undead_arose
                numerical_equals=0
            [/variable]

            [then]
                {TROLL_UNDEAD_UPRISING}

                [set_variable]
                    name=troll_undead_arose
                    value=1
                [/set_variable]
            [/then]
        [/if]
    [/event]

    [event]
        name=last breath

        [filter]
            id=Troll Chieftain
        [/filter]

        [message]
            speaker=Troll Chieftain
            message= _ "Argh! Curse you! May you never live to see daylight again!"
        [/message]

        {CHECK_SPEAKER}
        [message]
            speaker=speaking_unit
            message= _ "And so, at last, it ends."
        [/message]
        {CLEAR_VARIABLE speaking_unit}

        [message]
            side=4
            # wmllint: local spelling Da
            message= _ "Da big troll is dead. Run for your lives!"
        [/message]

        [kill]
            side=4
            animate=no
        [/kill]

        [terrain]
            x=61,62,63,64,65,66
            y=26,26,27,27,28,28
            terrain=Uu
        [/terrain]

        [move_unit_fake]
            type=Dwarvish Scout
            side=2
            x=66,61
            y=28,26
        [/move_unit_fake]

        {NAMED_NOTRAIT_UNIT 2 (Dwarvish Pathfinder) 61 26 (Grimnir) ( _ "Grimnir")}

        [remove_shroud]
            x=60-64
            y=25-28
            side=1
        [/remove_shroud]

        [redraw][/redraw]

        [delay]
            time=200
        [/delay]

        [message]
            speaker=Grimnir
            message= _ "News travels fast. The chaos you have sown has caused the foul trolls to start retreating. And now the architect of our suffering is dead. This war is far from over, but with your help we won this battle. You have our gratitude. Our King has instructed us to bring you to him; he wants to talk with you and reward you. He waits in our most hallowed hall, a place that no elf has seen for generations upon generations. It is a great honor, but you have done great deeds this day. Elves killing a troll chieftain! We will tell this story for years."
        [/message]

        [message]
            speaker=Nym
            message= _ "With their knowledge of all these secret tunnels, youâ€™d think they could have led us straight here instead of making us go through those â€˜light defensesâ€™. It would have saved us a lot of unnecessary fighting in actually getting to the troll chieftain."
        [/message]

        [message]
            speaker=Zhul
            message= _ "Perhaps they wanted to further test our prowess in battle. And besides, every troll we kill is one they donâ€™t have to. Still, I think we caused a bigger distraction then they were expecting."
        [/message]

        [message]
            speaker=Kaleh
            message= _ "Shhhh, you two. Yes, of course, we would be honored to come and meet your King. But first, we left many of our people back up near the entrance to the great cave where you first met us and I fear that even now those caves arenâ€™t safe. Can you help us escort my people to safety?"
        [/message]

        [message]
            speaker=Grimnir
            message= _ "Hmmmm, yes, after what you have done, I think I could arrange something. We have a few larger halls that should hold your people, a bit cramped, but safe. Since you first arrived, weâ€™ve had a few lads watch over them; you hid your folk in a good defensive location, but you can never be too sure. Iâ€™ll get them to help escort your people to safety. We certainly wouldnâ€™t want any surprises."
        [/message]

        [message]
            speaker=Kaleh
            message= _ "You are full of surprises. But I feel better knowing a few of your kind were watching out for the rest of my people. All right everyone, no celebrating yet, we still have work left to do!"
        [/message]

        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    # TROLL EASTER EGG EVENTS

    # Event 25: Dwarf Ghost

    [event]
        name=moveto

        # wmllint: recognize Dwarf Ghost
        [filter]
            x=16-20
            y=20-34
            side=1
        [/filter]

        {CHECK_EXPLORER}

        [message]
            speaker=$explorer.id
            message= _ "Itâ€™s cooler here, there seems to be a draft to the west."
        [/message]

        {NAMED_NOTRAIT_UNIT 6 (Haunt) 16 26 (Dwarf Ghost) ( _ "Dwarf Ghost")}

        [redraw][/redraw]

        [delay]
            time=300
        [/delay]

        [message]
            speaker=Dwarf Ghost
            message= _ "Hail, friend. Ages ago, I too fought the trolls and came to this place. But by ill luck I was burned to death by the lava and died nearby unblessed and unhonored. Find my body and grant me the peace I so dearly wish for. Do this and I will let you pass."
        [/message]

        {CLEAR_VARIABLE explorer}

        # Event 26: Dwarf Corpse (activated by previous event)
        [event]
            name=moveto
            first_time_only=no

            [filter]
                x,y=23,24
                side=1
            [/filter]

            [message]
                speaker=unit
                message= _ "Look, a crumbling skeleton. I think this might be the body of the dwarven ghost. It shouldnâ€™t take long to dig a shallow grave."
            [/message]

            [redraw]
            [/redraw]

            [delay]
                time=1000
            [/delay]

            [message]
                speaker=unit
                message= _ "May Eloh, or whatever god you worship, grant you peace and safe passage to the afterlife. We will avenge your death."
            [/message]

            # kills dwarf ghost blocking passage
            [kill]
                id=Dwarf Ghost
                animate=no
            [/kill]

            [terrain]
                x,y=16,26
                terrain=Re
            [/terrain]

            # create new unit so that ghost can deliver final dialogue before leaving
            {NAMED_NOTRAIT_UNIT 2 (Haunt) 14 13 (Dwarf Ghost) ( _ "Dwarf Ghost")}

            [redraw]
            [/redraw]

            [message]
                speaker=Dwarf Ghost
                message= _ "Thank you. You have done for me what all my dwarven kin never could. I will no longer block your way. May Moradin bless you and watch over you. I leave now for the halls of my ancestors..."
            [/message]

            [kill]
                id=Dwarf Ghost
                animate=yes
            [/kill]
        [/event]
    [/event]

    # Event 27: Troll Crypt Guardian

    [event]
        name=moveto

        [filter]
            x=8-17
            y=20-26
            side=1
        [/filter]

        {NAMED_NOTRAIT_UNIT 4 (Soulless) 13 22 cryptguard ( _ "Crypt Guardian")}
        {INVOKE_TROLL_VARIATION}

        {CHECK_EXPLORER}

        [message]
            speaker=$explorer.id
            message= _ "This looks like a troll crypt. Whoever it was must have been very important, because they have their own undead guardian."
        [/message]

        {CLEAR_VARIABLE explorer}
    [/event]

    # Event 28: Troll Coffin

    [event]
        name=moveto

        [filter]
            x=11-13
            y=20-22
            side=1
        [/filter]

        {CHECK_EXPLORER}

        [message]
            speaker=$explorer.id
            message= _ "There is a chasm here cutting off the end of the crypt. It must be rather recent; the edges are still raw and crumbling. It cuts off the path leading to a rather ornate stone coffin."
        [/message]

        {CLEAR_VARIABLE explorer}
    [/event]

    # Ransack Troll Coffin

    [event]
        name=moveto
        first_time_only=no

        [filter]
            x=9
            y=18
            side=1
            [not]
                type=Dust Devil
            [/not]
        [/filter]

        [if]
            [variable]
                name=took_wand
                numerical_equals=0
            [/variable]

            [then]
                [message]
                    speaker=unit

                    message= _ "For a troll this is quite an ornate tomb. The coffin itself is quite impressive. Inside, the skeleton has crumbled to dust and there are a few colored stones and trinkets, but what really sticks out is this emerald wand. I donâ€™t have much experience with magical items, but the asp with emerald eyes and large fangs carved around its shaft leave little doubt as to its power. We donâ€™t normally tolerate using poison, but extreme circumstances call for extreme measures and I have a feeling we may find this useful before our journey is over."
                    [option]
                        message= _ "It might be useful, Iâ€™ll take it."
                        [command]
                            [set_variable]
                                name=took_wand
                                value=1
                            [/set_variable]

                            [message]
                                speaker=unit
                                message= _ "The wand fits comfortably in my hand. It doesnâ€™t seem to have much of a range, but in close combat it could be quite useful."
                            [/message]

                            [object]
                                [filter]
                                    x,y=$x1,$y1
                                [/filter]

                                id=Troll Wand
                                name= _ "Emerald Wand of Poison"
                                description= _ "This wand makes this unitâ€™s melee attacks deal poison damage."

                                [effect]
                                    apply_to=attack
                                    range=melee
                                    [set_specials]
                                        {WEAPON_SPECIAL_POISON}
                                    [/set_specials]
                                [/effect]
                            [/object]
                        [/command]
                    [/option]

                    [option]
                        message= _ "On second thought, itâ€™s better to leave the dead in peace."

                        [command]
                            [allow_undo]
                            [/allow_undo]
                        [/command]
                    [/option]
                [/message]
            [/then]

            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

    #at victory, clear variables:

    [event]
        name=victory

        {CLEAR_VARIABLE summon_flame}
        {CLEAR_VARIABLE flame_counter}
        {CLEAR_VARIABLE troll_undead_arose}
        {CLEAR_VARIABLE took_wand}
    [/event]

    [event]
        name=time over

        [message]
            speaker=Kaleh
            message= _ "Oh no, we took too long and enemy reinforcements have arrived. Weâ€™ll surely be overwhelmed now!"
        [/message]
    [/event]

    {UTBS_INCLUDE utils/kaleh-abilities.cfg}
    {UTBS_INCLUDE utils/deaths.cfg}

#undef LAVA_CAVERN
#undef SUMMON_FIRE_GUARDIAN
[/scenario]
